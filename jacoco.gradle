apply plugin: 'jacoco'

jacoco {
    toolVersion = "$jacoco_version"
}
tasks.withType(Test) {
    jacoco.includeNoLocationClasses = true
    jacoco.excludes = ['jdk.internal.*']
}

// Creates tasks based on the application build variant (productFlavor + buildType = variant)
android.applicationVariants.all { variant ->
    def variantName = variant.name.capitalize()
    def autoGenerated = ['**/R.class',
                         '**/R$*.class',
                         '**/Manifest*.*',
                         'android/**/*.*',
                         '**/BuildConfig.*',
                         '**/*$ViewBinder*.*',
                         '**/*$ViewInjector*.*',
                         '**/Lambda$*.class',
                         '**/Lambda.class',
                         '**/*Lambda.class',
                         '**/*Lambda*.class',
                         '**/*Dagger*.*',
                         '**/*_MembersInjector.class',
                         '**/Dagger*Component*.class',
                         '**/Dagger*Subcomponent*.class',
                         '**/*Subcomponent$Builder.class',
                         '**/*Module_*Factory.class',
                         '**/KSApplication.*',
                         '**/ApplicationModule.*',
                         '**/*Activity*.*',
                         '**/*Fragment*.*',
                         '**/*ViewHolder*.*',
                         '**/*Toolbar*.*',
                         '**/*Dialog*.*',
                         '**/ui/*.*',
                         '**/ui/views/*.*',
                         '**/databinding/*.*',
                         '**/mock/*.*',
                         '**/services/*.*',
                         '**/firebase/*.*',
                         '**/fragment/*.*']

    /**
     * Generates Jacoco coverage reports based off the unit tests.
     */
    task("jacoco${variantName}Report", type: JacocoReport, dependsOn: "test${variantName}UnitTest") {
        group 'Reporting'
        description "Generate ${variantName} Jacoco coverage reports."

        reports {
            xml.enabled = true
            html.enabled = true
        }

        // variant.javaCompile.source does not work
        // traverses from starting point
        sourceDirectories.from = files(android.sourceSets.main.java.srcDirs)
        executionData.from = files("${buildDir}/jacoco/test${variantName}UnitTest.exec")
        classDirectories.from = fileTree(dir: variant.javaCompileProvider.get().destinationDir, excludes: autoGenerated)
    }

    tasks.koverHtmlReport  {
        htmlReportDir.set(layout.buildDirectory.dir("merged-report/html-result"))
        excludes =autoGenerated // exclusion rules for classes
    }
}

